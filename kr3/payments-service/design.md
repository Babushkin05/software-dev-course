# Design ‚Äî Payments Service

## üì¶ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞

`payments-service` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å—á–µ—Ç–∞–º–∏, –≤–∫–ª—é—á–∞—è:
- —Å–æ–∑–¥–∞–Ω–∏–µ —Å—á—ë—Ç–∞,
- –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞,
- –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞,
- —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ –∑–∞–∫–∞–∑—É (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ Kafka).

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/payments-service
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ api/                  # –ü—Ä–æ—Ç–æ–±–∞—Ñ-—Å—Ö–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ gen/              # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îî‚îÄ‚îÄ payments.proto
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ main.go           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ local.yaml        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ deployments/
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile        # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/           # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ db/               # –†–∞–±–æ—Ç–∞ —Å –ë–î –∏ schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ grpc/             # gRPC-—Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ kafka/            # Kafka consumer
‚îÇ   ‚îú‚îÄ‚îÄ model/            # –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ service/          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
```

---

## ‚öôÔ∏è –ë–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### üìå –û—Ç–∫—Ä—ã—Ç—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ API Gateway ‚Üí gRPC)

- `CreateAccount(user_id)` ‚Äî —Å–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç (–Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- `AddBalance(user_id, amount)` ‚Äî –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
- `GetBalance(user_id)` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å

### üìå –û–±—Ä–∞–±–æ—Ç–∫–∞ Kafka-—Å–æ–æ–±—â–µ–Ω–∏–π (`orders-topic`)

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∑–∞–∫–∞–∑—ã:
- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Kafka –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ —Å —É—á—ë—Ç–æ–º transactional inbox.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ **at-most-once**, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è.

---

## üõ¢Ô∏è –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

### üíæ –¢–∞–±–ª–∏—Ü—ã
- `accounts(id, user_id, balance, created_at)`
- `inbox(message_id, topic, payload, processed, created_at)`

### üìÑ `schema.sql`
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã —Å –Ω—É–ª—è.
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–∑ `internal/db/schema.sql`.

---

## üß† –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `AccountStorage`

```go
type AccountStorage interface {
	Create(ctx context.Context, userID string) (*model.Account, error)
	AddBalance(ctx context.Context, userID string, amount int64) (int64, error)
	GetBalance(ctx context.Context, userID string) (int64, error)
	Withdraw(ctx context.Context, userID string, amount int64) (int64, error)

	// Inbox –ø–∞—Ç—Ç–µ—Ä–Ω
	SaveInboxMessage(msg InboxMessage) error
	FetchUnprocessedInboxMessages(limit int) ([]InboxMessage, error)
	MarkInboxMessageProcessed(messageID string) error
}
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ `sql.DB` (PostgreSQL).
- –°–ø–∏—Å–∞–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –≥–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ `WHERE balance >= amount`.

---

## üì¨ Kafka: Consumer + Inbox Pattern

- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Kafka consumer (`StartKafkaConsumer`) —á–µ—Ä–µ–∑ `segmentio/kafka-go`.
- –ö–∞–∂–¥–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `inbox`, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –∏ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `processed`.
- –ì–∞—Ä–∞–Ω—Ç–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ `ON CONFLICT (message_id) DO NOTHING`.

---

## üß™ –¢–µ—Å—Ç—ã

- –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (—á–µ—Ä–µ–∑ –º–æ–∫-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π).
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `testify/mock` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è `MockStorage`.
- –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç: —Å–æ–∑–¥–∞–Ω–∏–µ, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞, —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤).

---

## ‚öôÔ∏è Devtools

### Makefile
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: `make run`
- –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ docker: `make docker-run`
- –≥–µ–Ω–µ—Ä–∞—Ü–∏—é protobuf: `make proto`

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
grpc:
  port: ":50051"

database:
  dsn: "postgres://user:password@localhost:5432/payments?sslmode=disable"

kafka:
  broker: "localhost:9092"
  topic: "orders-topic"
  group_id: "payments-group"
```

---

## üß© –ü—Ä–æ—Ç–æ–±–∞—Ñ

- –°–µ—Ä–≤–∏—Å–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `api/payments.proto`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è gRPC –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤.

---

