# üß© `payments-service` Design Document

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–µ–π. –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî **—Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ —Å –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞**. –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ –∏–ª–∏ –Ω–µ—É–¥–∞—á–∏ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ `orders-service` —á–µ—Ä–µ–∑ Kafka.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
payments-service/
‚îÇ
‚îú‚îÄ‚îÄ api/                  # gRPC protobuf definitions (compiled)
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/           # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ env
‚îÇ   ‚îú‚îÄ‚îÄ db/               # –†–∞–±–æ—Ç–∞ —Å Postgres (AccountRepository, inbox, outbox)
‚îÇ   ‚îú‚îÄ‚îÄ grpc/             # gRPC —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ kafka/            # Kafka consumer/producer
‚îÇ   ‚îî‚îÄ‚îÄ service/          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (AccountService)
‚îÇ
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ main.go           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
```

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### ‚úÖ gRPC API

–ú–µ—Ç–æ–¥—ã:
- `CreateAccount`
- `AddBalance`
- `GetBalance`

### üì¶ Kafka

- üì• `order_created` (inbox)
- üì§ `order_finished`, `order_canceled` (outbox)

### üß† –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (`AccountService`)
- `Withdraw(ctx, userID, orderID, amount)` ‚Äî —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
  - –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ ‚Üí `order_finished`
  - –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤) ‚Üí `order_canceled`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ `outbox`, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ Kafka

---

## üóÑÔ∏è –•—Ä–∞–Ω–∏–ª–∏—â–µ

PostgreSQL, 2 –∫–ª—é—á–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

### `accounts`
| id | user_id | balance | created_at |

### `inbox`
| message_id | topic | payload | processed | created_at |

### `outbox`
| id | topic | key | payload | dispatched | created_at |

---

## üîÅ –ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏

### ‚úÖ Inbox Pattern
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ Kafka-—Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ç–æ—á–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑

### ‚úÖ Outbox Pattern
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É —Å–æ–±—ã—Ç–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞

---

## ‚öôÔ∏è –í–æ—Ä–∫–µ—Ä—ã

### `InboxProcessor`
- –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã:
  - –ß–∏—Ç–∞–µ—Ç `inbox` (–Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ)
  - –ü–∞—Ä—Å–∏—Ç –∑–∞–∫–∞–∑
  - –í—ã–∑—ã–≤–∞–µ—Ç `Withdraw`
  - –ü–æ–º–µ—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ `processed`

### `OutboxDispatcher`
- –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã:
  - –ß–∏—Ç–∞–µ—Ç `outbox` (–Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ)
  - –ü—É–±–ª–∏–∫—É–µ—Ç –≤ Kafka
  - –ü–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ `dispatched = true`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ü–æ–∫—Ä—ã—Ç–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- –ü–æ–∫—Ä—ã—Ç–∏–µ —Å mock-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ (`AccountStorage`, `KafkaWriter`)
- –ü—Ä–æ–≤–µ—Ä–∫–∞:
  - –£—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
  - –û—à–∏–±–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤
  - –ó–∞–ø–∏—Å–∏ –≤ `outbox`

`coverage: 17.9% of statements`
